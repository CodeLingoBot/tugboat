#!/bin/bash

# Expects the following environment variables to be set:
#
# $SSH_KEY:     Private key to use when deploying.
# $REPO:        The repo to deploy.
# $TREEISH:     The branch to checkout. Or...
# $ENVIRONMENT: e.g. production, staging, etc.

echo "$SSH_KEY" > "$HOME/id_rsa"
chmod 0600 "$HOME/id_rsa"

# Use a shimmed ssh command.
export GIT_SSH="$HOME/bin/ssh"

# Work in a temp directory.
cd $(mktemp -d)

# Checkout the repo.
git init .
git remote add origin "$REPO"
git fetch -q origin

git reset -q --hard "origin/$TREEISH"

# Run the projects deploy script.
./script/deploy
